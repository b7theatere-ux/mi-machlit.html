<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מי מחליט? - הגרסה המשודרגת</title>
    <style>
        :root {
            --omer-color: #9c27b0; /* סגול */
            --elia-color: #4caf50; /* ירוק */
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            background: var(--bg-gradient);
            margin: 0;
            padding: 10px;
            touch-action: manipulation;
        }

        .container {
            max-width: 500px;
            margin: auto;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        h1 { color: #333; font-size: 24px; }

        /* תפריט בחירת נושא */
        .category-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .cat-btn {
            background: white;
            border: 2px solid #ddd;
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: 0.3s;
        }

        .cat-btn.active {
            border-color: #ff9800;
            background: #fff3e0;
        }

        /* הגדרות ומשחקים */
        .menu-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 20px;
            border-radius: 15px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
        }

        button:active { transform: scale(0.95); }

        .main-btn { background: #ff9800; color: white; width: 100%; margin: 5px 0; font-size: 18px; }
        .omer-btn { background: var(--omer-color); color: white; flex: 1; margin: 5px; }
        .elia-btn { background: var(--elia-color); color: white; flex: 1; margin: 5px; }

        #screen {
            margin: 20px 0;
            padding: 40px 20px;
            background: #f9f9f9;
            border-radius: 20px;
            min-height: 100px;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border: 3px dashed #ccc;
            position: relative;
        }

        /* גלגל */
        #wheel {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 5px solid #333;
            transition: transform 3s cubic-bezier(0.1, 0, 0.2, 1);
            background: conic-gradient(var(--omer-color) 0% 50%, var(--elia-color) 50% 100%);
            display: none;
            margin: 10px auto;
        }

        /* טבלת ניצחונות */
        .scoreboard {
            background: #eee;
            padding: 10px;
            border-radius: 15px;
            margin-top: 15px;
        }

        /* פופאפ ניצחון */
        #winner-popup {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            color: white;
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            text-align: center;
        }

        .settings-panel {
            font-size: 14px;
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 10px;
        }

        .timer { font-size: 40px; color: #e91e63; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>?? מי מחליט הפעם?</h1>

    <div id="category-selector" class="category-grid">
        <button class="cat-btn" onclick="setTask('מתקלח אחרון')">?? מקלחת</button>
        <button class="cat-btn" onclick="setTask('רואה TV ראשון')">?? טלוויזיה</button>
        <button class="cat-btn" onclick="setTask('משחק בסוני ראשון')">?? סוני</button>
        <button class="cat-btn" onclick="setTask('יושב ליד החלון')">?? חלון</button>
        <button class="cat-btn" onclick="setTask('סתם משעמם לנו')">?? סתם משחק</button>
        <button class="cat-btn" onclick="setTask(prompt('מה המשימה?'))">?? אחר</button>
    </div>

    <div class="menu-row">
        <span>הטוב מ:</span>
        <select id="gameMode" onchange="resetSeries()">
            <option value="1">משחק אחד</option>
            <option value="3">הטוב מ-3</option>
            <option value="5">הטוב מ-5</option>
        </select>
    </div>

    <button class="main-btn" onclick="startReaction()">? משחק תגובה</button>
    <button class="main-btn" onclick="startWheel()">?? גלגל מזל</button>
    <button class="main-btn" onclick="startNumberGame()">?? מספר סודי (1-10)</button>

    <div id="screen">בחר נושא ומשחק!</div>
    <div id="wheel"></div>

    <div class="menu-row" id="player-buttons" style="display: none;">
        <button id="btn-omer" class="omer-btn" onclick="playerAction('omer')">עומר</button>
        <button id="btn-elia" class="elia-btn" onclick="playerAction('elia')">אליה</button>
    </div>

    <div class="scoreboard">
        <strong>ניצחונות בסדרה:</strong><br>
        <span id="name1">עומר</span>: <span id="s1">0</span> | <span id="name2">אליה</span>: <span id="s2">0</span>
        <hr>
        <strong>סך הכל ניצחונות:</strong><br>
        ?? <span id="total1">0</span> - <span id="total2">0</span>
        <br>
        <button onclick="resetAllScores()" style="font-size:10px; margin-top:5px;">אפס הכל</button>
    </div>

    <div class="settings-panel">
        <button onclick="changeNames()">שנה שמות</button>
        <button onclick="exportCode()">ייצוא קוד</button>
    </div>
</div>

<div id="winner-popup">
    <div id="winner-text"></div>
    <button onclick="closePopup()" style="margin-top:20px; background:white; color:black;">מעולה!</button>
</div>

<script>
    let state = {
        name1: "עומר", name2: "אליה",
        score1: 0, score2: 0,
        total1: parseInt(localStorage.getItem('total1')) || 0,
        total2: parseInt(localStorage.getItem('total2')) || 0,
        currentTask: "",
        canPress: false,
        gameActive: false,
        timer: null
    };

    // עדכון ראשוני של הטבלה
    updateUI();

    function setTask(task) {
        state.currentTask = task;
        document.getElementById('screen').innerText = "המשימה: " + task + "\nעכשיו בחרו משחק!";
    }

    function updateUI() {
        document.getElementById('name1').innerText = state.name1;
        document.getElementById('name2').innerText = state.name2;
        document.getElementById('btn-omer').innerText = state.name1;
        document.getElementById('btn-elia').innerText = state.name2;
        document.getElementById('s1').innerText = state.score1;
        document.getElementById('s2').innerText = state.score2;
        document.getElementById('total1').innerText = state.total1;
        document.getElementById('total2').innerText = state.total2;
    }

    // --- משחק תגובה ---
    function startReaction() {
        resetGameView();
        const screen = document.getElementById('screen');
        screen.style.background = "#ffcdd2";
        screen.innerText = "חכו לירוק...";
        document.getElementById('player-buttons').style.display = 'flex';
        
        let delay = Math.random() * 3000 + 2000;
        state.gameActive = true;
        state.canPress = false;

        state.timer = setTimeout(() => {
            if(!state.gameActive) return;
            screen.style.background = "#c8e6c9";
            screen.innerText = "ללחוץ עכשיו!!!";
            state.canPress = true;
        }, delay);
    }

    // --- גלגל המזל ---
    function startWheel() {
        resetGameView();
        const wheel = document.getElementById('wheel');
        wheel.style.display = 'block';
        let rotation = 1440 + Math.random() * 1440;
        wheel.style.transform = `rotate(${rotation}deg)`;
        
        setTimeout(() => {
            const finalAngle = rotation % 360;
            // חצי סגול חצי ירוק (180 מעלות כל אחד)
            let winner = (finalAngle <= 180) ? 'elia' : 'omer';
            winRound(winner);
        }, 3100);
    }

    // --- משחק המספר ---
    function startNumberGame() {
        resetGameView();
        let timeLeft = 10;
        const screen = document.getElementById('screen');
        screen.innerHTML = `תחשבו על מספר (1-10)... <br><span class="timer" id="t-clock">10</span>`;
        
        let interval = setInterval(() => {
            timeLeft--;
            document.getElementById('t-clock').innerText = timeLeft;
            if(timeLeft <= 0) {
                clearInterval(interval);
                const secret = Math.floor(Math.random() * 10) + 1;
                screen.innerHTML = `המספר הסודי הוא: <div style="font-size:50px">${secret}</div> מי היה הכי קרוב?`;
                document.getElementById('player-buttons').style.display = 'flex';
                state.canPress = true; // במקרה הזה הכפתור משמש לסימון המנצח
            }
        }, 1000);
    }

    function playerAction(player) {
        if (!state.gameActive && !state.canPress) return;

        // במשחק תגובה - בדיקת פסילה
        if (state.gameActive && !state.canPress) {
            alert( (player === 'omer' ? state.name1 : state.name2) + " לחץ מוקדם מדי! הנקודה עוברת לצד השני.");
            winRound(player === 'omer' ? 'elia' : 'omer');
            return;
        }

        winRound(player);
    }

    function winRound(player) {
        state.gameActive = false;
        state.canPress = false;
        if(player === 'omer') state.score1++;
        else state.score2++;
        
        updateUI();
        checkSeriesWinner();
    }

    function checkSeriesWinner() {
        const target = parseInt(document.getElementById('gameMode').value);
        const winThreshold = Math.ceil(target / 2);

        if (state.score1 >= winThreshold) {
            showWinner(state.name1);
            state.total1++;
        } else if (state.score2 >= winThreshold) {
            showWinner(state.name2);
            state.total2++;
        } else {
            document.getElementById('screen').innerText = "נקודה ל" + (state.score1 > state.score2 ? state.name1 : state.name2) + "! ממשיכים...";
        }
        localStorage.setItem('total1', state.total1);
        localStorage.setItem('total2', state.total2);
        updateUI();
    }

    function showWinner(name) {
        const popup = document.getElementById('winner-popup');
        const text = document.getElementById('winner-text');
        text.innerText = `?? הניצחון ל${name}!\nהוא/היא קובע ש${state.currentTask}!`;
        popup.style.display = 'flex';
        resetSeries();
    }

    function resetGameView() {
        clearTimeout(state.timer);
        state.gameActive = false;
        state.canPress = false;
        document.getElementById('screen').innerText = "...";
        document.getElementById('screen').style.background = "#f9f9f9";
        document.getElementById('wheel').style.display = 'none';
        document.getElementById('player-buttons').style.display = 'none';
    }

    function resetSeries() {
        state.score1 = 0;
        state.score2 = 0;
        updateUI();
    }

    function resetAllScores() {
        if(confirm("לאפס את כל טבלת הניצחונות ההיסטורית?")) {
            state.total1 = 0; state.total2 = 0;
            localStorage.clear();
            resetSeries();
        }
    }

    function closePopup() {
        document.getElementById('winner-popup').style.display = 'none';
        resetGameView();
    }

    function changeNames() {
        state.name1 = prompt("שם הילד (סגול):", state.name1) || state.name1;
        state.name2 = prompt("שם הילדה (ירוק):", state.name2) || state.name2;
        updateUI();
    }

    function exportCode() {
        const code = document.documentElement.outerHTML;
        const blob = new Blob([code], {type: "text/html"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "mi_machlit.html";
        a.click();
    }
</script>

</body>
</html>